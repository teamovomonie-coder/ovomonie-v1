import * as React from "react";
import { cn } from "@/lib/utils";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { 
    Eye, 
    EyeOff, 
    Shield, 
    AlertCircle, 
    CheckCircle,
    Lock,
    CreditCard,
    DollarSign
} from "lucide-react";

interface FintechInputProps extends React.InputHTMLAttributes<HTMLInputElement> {
    label?: string;
    error?: string;
    success?: string;
    secure?: boolean;
    currency?: boolean;
    cardNumber?: boolean;
    loading?: boolean;
    strength?: 'weak' | 'medium' | 'strong';
}

const FintechInput = React.forwardRef<HTMLInputElement, FintechInputProps>(
    ({ 
        className, 
        type, 
        label, 
        error, 
        success, 
        secure, 
        currency, 
        cardNumber, 
        loading,
        strength,
        ...props 
    }, ref) => {
        const [showPassword, setShowPassword] = React.useState(false);
        const [value, setValue] = React.useState(props.value || '');\n        const isPassword = type === 'password';\n        const inputType = isPassword && showPassword ? 'text' : type;\n\n        const formatCardNumber = (value: string) => {\n            return value.replace(/\\s/g, '').replace(/(\\d{4})/g, '$1 ').trim();\n        };\n\n        const formatCurrency = (value: string) => {\n            const numericValue = value.replace(/[^\\d]/g, '');\n            return new Intl.NumberFormat('en-NG').format(Number(numericValue));\n        };\n\n        const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n            let newValue = e.target.value;\n            \n            if (cardNumber) {\n                newValue = formatCardNumber(newValue.slice(0, 19));\n            } else if (currency) {\n                newValue = formatCurrency(newValue);\n            }\n            \n            setValue(newValue);\n            if (props.onChange) {\n                const syntheticEvent = {\n                    ...e,\n                    target: { ...e.target, value: newValue }\n                };\n                props.onChange(syntheticEvent as React.ChangeEvent<HTMLInputElement>);\n            }\n        };\n\n        const getStrengthColor = () => {\n            switch (strength) {\n                case 'weak': return 'bg-red-500';\n                case 'medium': return 'bg-yellow-500';\n                case 'strong': return 'bg-green-500';\n                default: return 'bg-gray-300';\n            }\n        };\n\n        return (\n            <div className=\"space-y-2\">\n                {label && (\n                    <div className=\"flex items-center justify-between\">\n                        <Label className=\"text-sm font-medium text-foreground flex items-center gap-2\">\n                            {secure && <Lock className=\"h-3 w-3 text-muted-foreground\" />}\n                            {label}\n                        </Label>\n                        {strength && (\n                            <div className=\"flex items-center gap-2\">\n                                <div className=\"flex gap-1\">\n                                    <div className={cn(\"h-1 w-2 rounded-full\", \n                                        strength === 'weak' ? 'bg-red-500' : 'bg-gray-300'\n                                    )} />\n                                    <div className={cn(\"h-1 w-2 rounded-full\", \n                                        ['medium', 'strong'].includes(strength) ? 'bg-yellow-500' : 'bg-gray-300'\n                                    )} />\n                                    <div className={cn(\"h-1 w-2 rounded-full\", \n                                        strength === 'strong' ? 'bg-green-500' : 'bg-gray-300'\n                                    )} />\n                                </div>\n                                <span className=\"text-xs text-muted-foreground capitalize\">\n                                    {strength}\n                                </span>\n                            </div>\n                        )}\n                    </div>\n                )}\n                \n                <div className=\"relative\">\n                    {currency && (\n                        <div className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\">\n                            <DollarSign className=\"h-4 w-4\" />\n                        </div>\n                    )}\n                    \n                    {cardNumber && (\n                        <div className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\">\n                            <CreditCard className=\"h-4 w-4\" />\n                        </div>\n                    )}\n                    \n                    <Input\n                        ref={ref}\n                        type={inputType}\n                        value={value}\n                        onChange={handleChange}\n                        className={cn(\n                            \"transition-all duration-200\",\n                            currency && \"pl-10\",\n                            cardNumber && \"pl-10 font-mono tracking-wider\",\n                            (isPassword || secure) && \"pr-10\",\n                            error && \"border-destructive focus-visible:ring-destructive\",\n                            success && \"border-green-500 focus-visible:ring-green-500\",\n                            loading && \"opacity-50 cursor-not-allowed\",\n                            className\n                        )}\n                        disabled={loading}\n                        {...props}\n                    />\n                    \n                    {(isPassword || secure) && (\n                        <Button\n                            type=\"button\"\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            className=\"absolute right-0 top-0 h-full px-3 hover:bg-transparent\"\n                            onClick={() => setShowPassword(!showPassword)}\n                            disabled={loading}\n                        >\n                            {showPassword ? (\n                                <EyeOff className=\"h-4 w-4 text-muted-foreground\" />\n                            ) : (\n                                <Eye className=\"h-4 w-4 text-muted-foreground\" />\n                            )}\n                        </Button>\n                    )}\n                    \n                    {loading && (\n                        <div className=\"absolute right-3 top-1/2 -translate-y-1/2\">\n                            <div className=\"h-4 w-4 border-2 border-primary/30 border-t-primary rounded-full animate-spin\" />\n                        </div>\n                    )}\n                </div>\n                \n                {(error || success) && (\n                    <div className={cn(\n                        \"flex items-center gap-2 text-xs\",\n                        error ? \"text-destructive\" : \"text-green-600\"\n                    )}>\n                        {error ? (\n                            <AlertCircle className=\"h-3 w-3\" />\n                        ) : (\n                            <CheckCircle className=\"h-3 w-3\" />\n                        )}\n                        {error || success}\n                    </div>\n                )}\n            </div>\n        );\n    }\n);\n\nFintechInput.displayName = \"FintechInput\";\n\n// PIN Input Component\ninterface PinInputProps {\n    length?: number;\n    onComplete?: (pin: string) => void;\n    loading?: boolean;\n    error?: string;\n    className?: string;\n}\n\nconst PinInput = React.forwardRef<HTMLDivElement, PinInputProps>(\n    ({ length = 4, onComplete, loading, error, className }, ref) => {\n        const [pins, setPins] = React.useState<string[]>(new Array(length).fill(''));\n        const inputRefs = React.useRef<(HTMLInputElement | null)[]>([]);\n\n        const handleChange = (index: number, value: string) => {\n            if (value.length > 1) return;\n            \n            const newPins = [...pins];\n            newPins[index] = value;\n            setPins(newPins);\n            \n            if (value && index < length - 1) {\n                inputRefs.current[index + 1]?.focus();\n            }\n            \n            if (newPins.every(pin => pin !== '') && onComplete) {\n                onComplete(newPins.join(''));\n            }\n        };\n\n        const handleKeyDown = (index: number, e: React.KeyboardEvent) => {\n            if (e.key === 'Backspace' && !pins[index] && index > 0) {\n                inputRefs.current[index - 1]?.focus();\n            }\n        };\n\n        return (\n            <div ref={ref} className={cn(\"space-y-4\", className)}>\n                <div className=\"flex items-center justify-center gap-3\">\n                    {pins.map((pin, index) => (\n                        <Input\n                            key={index}\n                            ref={(el) => (inputRefs.current[index] = el)}\n                            type=\"password\"\n                            inputMode=\"numeric\"\n                            pattern=\"[0-9]*\"\n                            maxLength={1}\n                            value={pin}\n                            onChange={(e) => handleChange(index, e.target.value)}\n                            onKeyDown={(e) => handleKeyDown(index, e)}\n                            className={cn(\n                                \"w-12 h-12 text-center text-lg font-semibold\",\n                                \"border-2 rounded-lg transition-all duration-200\",\n                                pin ? \"border-primary bg-primary/5\" : \"border-border\",\n                                error && \"border-destructive\",\n                                loading && \"opacity-50 cursor-not-allowed\"\n                            )}\n                            disabled={loading}\n                        />\n                    ))}\n                </div>\n                \n                {error && (\n                    <div className=\"flex items-center justify-center gap-2 text-xs text-destructive\">\n                        <AlertCircle className=\"h-3 w-3\" />\n                        {error}\n                    </div>\n                )}\n                \n                <div className=\"flex items-center justify-center gap-2 text-xs text-muted-foreground\">\n                    <Shield className=\"h-3 w-3\" />\n                    Your PIN is encrypted and secure\n                </div>\n            </div>\n        );\n    }\n);\n\nPinInput.displayName = \"PinInput\";\n\nexport { FintechInput, PinInput };