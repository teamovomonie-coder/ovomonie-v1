# Ovomonie Database Schema Documentation

> Comprehensive Firestore schema for the Ovomonie fintech platform. Updated December 13, 2025.

---

## Table of Contents
1. [Core Collections](#core-collections)
2. [Subcollections](#subcollections)
3. [Financial & Transaction Collections](#financial--transaction-collections)
4. [Booking & Order Collections](#booking--order-collections)
5. [Asset & Holding Collections](#asset--holding-collections)
6. [Support & Utility Collections](#support--utility-collections)
7. [Data Types & Enums](#data-types--enums)
8. [Indexing Strategy](#indexing-strategy)
9. [Limits & KYC Configuration](#limits--kyc-configuration)

---

## Core Collections

### 1. **users**
Stores user account information and authentication details.

**Document ID**: `userId` (auto-generated by Firebase Auth)

**Fields**:

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `phone` | string | ✅ | E.164 format, must be unique |
| `fullName` | string | ✅ | User's full name |
| `email` | string | ❌ | User's email address |
| `accountNumber` | string | ✅ | 10-digit virtual account number, unique |
| `balance` | number | ✅ | Account balance in kobo (1 Naira = 100 kobo) |
| `loginPinHash` | string | ✅ | Scrypt-hashed login PIN |
| `transactionPinHash` | string | ❌ | Scrypt-hashed transaction PIN |
| `kycTier` | number | ✅ | 1, 2, 3, or 4 (corporate) |
| `isAgent` | boolean | ✅ | Whether user is an agent |
| `status` | string | ✅ | `active`, `locked`, or `pending` |
| `address` | object | ❌ | See [UserAddress](#useraddress) |
| `agent` | object | ❌ | See [AgentDetails](#agentdetails) (only if `isAgent === true`) |
| `lastLoginAt` | Timestamp | ❌ | Last login timestamp |
| `lastLogoutAll` | Timestamp | ❌ | Bump to invalidate all tokens |
| `failedLoginCount` | number | ❌ | Consecutive failed login attempts |
| `bvnHash` | string | ❌ | Hashed Bank Verification Number |
| `ninHash` | string | ❌ | Hashed National Identification Number |
| `referralCode` | string | ❌ | Unique referral code for this user |
| `mfaEnabled` | boolean | ❌ | Multi-factor authentication enabled flag |
| `preferredLanguage` | string | ❌ | Language preference (e.g., "en", "fr", "yo") |
| `avatarUrl` | string | ❌ | Profile picture URL |
| `createdAt` | Timestamp | ✅ | Account creation timestamp |
| `updatedAt` | Timestamp | ✅ | Last profile update timestamp |

**Indexes**:
- Single-field: `phone`, `status`, `accountNumber`
- Composite: `(isAgent, region)` for agent discovery

**Example**:
```json
{
  "phone": "+2348012345678",
  "fullName": "John Doe",
  "email": "john@example.com",
  "accountNumber": "1234567890",
  "balance": 50000000,
  "loginPinHash": "scrypt:hash",
  "kycTier": 2,
  "isAgent": false,
  "status": "active",
  "createdAt": "2024-01-15T10:30:00Z",
  "updatedAt": "2024-01-20T14:22:00Z"
}
```

---

### 2. **notifications**
User notifications for transactions, updates, and system messages.

**Document ID**: Auto-generated

**Fields**:

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `userId` | string | ✅ | ID of the recipient user |
| `title` | string | ✅ | Notification title |
| `body` | string | ✅ | Notification message |
| `category` | string | ✅ | `transfer`, `transaction`, `general`, `system`, `alert` |
| `type` | string | ❌ | `debit`, `credit`, or generic type |
| `read` | boolean | ✅ | Read status |
| `amount` | number | ❌ | Transaction amount in kobo (if applicable) |
| `senderName` | string | ❌ | Name of sender (for transfer notifications) |
| `recipientName` | string | ❌ | Name of recipient (for transfer notifications) |
| `reference` | string | ❌ | Transaction reference ID |
| `createdAt` | Timestamp | ✅ | Notification creation timestamp |

**Indexes**:
- Composite: `(userId, createdAt)` for real-time fetching
- Single-field: `userId`

**Example**:
```json
{
  "userId": "user123",
  "title": "Money Received",
  "body": "Account credited by Jane Smith",
  "category": "transfer",
  "type": "credit",
  "read": false,
  "amount": 1000000,
  "senderName": "Jane Smith",
  "reference": "TXN123456",
  "createdAt": "2024-01-20T15:00:00Z"
}
```

---

## Subcollections

### 3. **users/{userId}/virtualCards**
Virtual card instances issued to a user.

**Document ID**: Card ID (auto-generated)

**Fields**:

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `cardNumber` | string | ✅ | Masked or full card number |
| `expiryDate` | string | ✅ | MM/YY format |
| `cvv` | string | ✅ | Card security code |
| `cardPin` | string | ❌ | Card PIN (if needed) |
| `balance` | number | ✅ | Card balance in kobo |
| `isActive` | boolean | ✅ | Active/inactive status |
| `cardType` | string | ❌ | e.g., "visa", "mastercard" |
| `createdAt` | Timestamp | ✅ | Card creation timestamp |
| `expiresAt` | Timestamp | ❌ | Card expiration timestamp |

---

### 4. **users/{userId}/cardOrders**
Physical card orders placed by a user.

**Document ID**: Order ID (auto-generated)

**Fields**:

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `status` | string | ✅ | `pending`, `approved`, `processing`, `shipped`, `delivered` |
| `cardType` | string | ✅ | Type of card ordered |
| `deliveryAddress` | object | ✅ | Delivery address object |
| `amount` | number | ❌ | Order cost in kobo |
| `reference` | string | ✅ | Unique order reference |
| `createdAt` | Timestamp | ✅ | Order creation timestamp |
| `updatedAt` | Timestamp | ✅ | Last status update |

---

## Financial & Transaction Collections

### 5. **financialTransactions**
Complete ledger of all financial activities.

**Document ID**: Auto-generated

**Fields**:

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `userId` | string | ✅ | User performing the transaction |
| `category` | string | ✅ | `transfer`, `card_funding`, `bill_payment`, `airtime`, `betting`, `loan`, `investment`, `stock_trade` |
| `type` | string | ✅ | `debit` or `credit` |
| `amount` | number | ✅ | Transaction amount in kobo |
| `reference` | string | ✅ | Unique transaction reference (for idempotency) |
| `narration` | string | ✅ | Transaction description |
| `party` | object | ✅ | See [TransactionParty](#transactionparty) |
| `balanceAfter` | number | ✅ | Account balance after transaction |
| `timestamp` | Timestamp | ✅ | Transaction execution time |
| `memoMessage` | string | ❌ | Optional memo/message |
| `memoImageUri` | string | ❌ | Optional memo image URL |
| `metadata` | object | ❌ | Additional transaction metadata |

**Indexes**:
- Composite: `(userId, type, timestamp)` for user transaction history
- Composite: `(userId, category, timestamp)` for category-filtered history
- Single-field: `reference` for idempotency checks

**Example**:
```json
{
  "userId": "user123",
  "category": "transfer",
  "type": "debit",
  "amount": 1000000,
  "reference": "TXN20240120001",
  "narration": "Transfer to Jane Smith",
  "party": {
    "name": "Jane Smith",
    "account": "0987654321",
    "bank": "Ovomonie"
  },
  "balanceAfter": 49000000,
  "timestamp": "2024-01-20T15:00:00Z"
}
```

---

### 6. **loans**
Loan applications and disbursements.

**Document ID**: Auto-generated

**Fields**:

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `userId` | string | ✅ | Borrower user ID |
| `loanType` | string | ✅ | Type of loan (e.g., "personal", "business") |
| `principal` | number | ✅ | Original loan amount in kobo |
| `balance` | number | ✅ | Outstanding balance in kobo |
| `duration` | number | ✅ | Loan duration in months |
| `interestRate` | number | ✅ | Monthly interest rate (0.05 = 5%) |
| `purpose` | string | ✅ | Loan purpose |
| `status` | string | ✅ | `Active`, `Completed`, `Defaulted` |
| `startDate` | Timestamp | ✅ | Loan disbursement date |
| `repayments` | array | ✅ | See [Repayment](#repayment) |

**Indexes**:
- Composite: `(userId, status)` for active loan lookup

**Example**:
```json
{
  "userId": "user123",
  "loanType": "personal",
  "principal": 500000000,
  "balance": 525000000,
  "duration": 12,
  "interestRate": 0.05,
  "purpose": "Business expansion",
  "status": "Active",
  "startDate": "2024-01-01T00:00:00Z",
  "repayments": [...]
}
```

---

### 7. **investments**
Investment portfolios and product holdings.

**Document ID**: Auto-generated

**Fields**:

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `userId` | string | ✅ | Investor user ID |
| `productName` | string | ✅ | Investment product name |
| `amount` | number | ✅ | Investment amount in kobo |
| `expectedReturn` | number | ✅ | Expected return in kobo |
| `interestRate` | number | ✅ | Annual interest rate |
| `duration` | number | ✅ | Investment duration in months |
| `status` | string | ✅ | `Active`, `Matured`, `Withdrawn` |
| `startDate` | Timestamp | ✅ | Investment start date |
| `maturityDate` | Timestamp | ✅ | Expected maturity date |

---

### 8. **stockHoldings**
User stock trading portfolio.

**Document ID**: Auto-generated

**Fields**:

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `userId` | string | ✅ | Trader user ID |
| `symbol` | string | ✅ | Stock ticker symbol (e.g., "APPL") |
| `quantity` | number | ✅ | Number of shares owned |
| `averageBuyPrice` | number | ✅ | Average purchase price in kobo |
| `currentPrice` | number | ✅ | Current market price in kobo |
| `totalValue` | number | ✅ | Total portfolio value in kobo |
| `gain` | number | ✅ | Unrealized gain/loss in kobo |

---

## Booking & Order Collections

### 9. **eventBookings**
Event ticket bookings and reservations.

**Document ID**: Auto-generated

**Fields**:

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `userId` | string | ✅ | Ticket buyer user ID |
| `eventId` | string | ✅ | Event reference ID |
| `quantity` | number | ✅ | Number of tickets |
| `totalAmount` | number | ✅ | Total booking cost in kobo |
| `status` | string | ✅ | `Confirmed`, `Pending`, `Cancelled` |
| `reference` | string | ✅ | Booking reference |
| `createdAt` | Timestamp | ✅ | Booking timestamp |

---

### 10. **hotelBookings**
Hotel room reservations.

**Document ID**: Auto-generated

**Fields**:

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `userId` | string | ✅ | Guest user ID |
| `hotelId` | string | ✅ | Hotel reference |
| `checkInDate` | Timestamp | ✅ | Check-in date |
| `checkOutDate` | Timestamp | ✅ | Check-out date |
| `numberOfRooms` | number | ✅ | Rooms reserved |
| `totalAmount` | number | ✅ | Total booking cost in kobo |
| `reference` | string | ✅ | Booking reference |
| `status` | string | ✅ | `Confirmed`, `Pending`, `Cancelled` |

---

### 11. **flightBookings**
Flight ticket reservations.

**Document ID**: Auto-generated

**Fields**:

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `userId` | string | ✅ | Passenger user ID |
| `flightId` | string | ✅ | Flight reference |
| `departureDate` | Timestamp | ✅ | Departure date |
| `numberOfPassengers` | number | ✅ | Passengers |
| `totalAmount` | number | ✅ | Booking cost in kobo |
| `reference` | string | ✅ | Booking reference |
| `status` | string | ✅ | `Confirmed`, `Pending`, `Cancelled` |

---

### 12. **rideBookings**
Ride-hailing booking records.

**Document ID**: Auto-generated

**Fields**:

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `userId` | string | ✅ | Passenger user ID |
| `pickupLocation` | string | ✅ | Pickup address |
| `dropoffLocation` | string | ✅ | Dropoff address |
| `fare` | number | ✅ | Ride fare in kobo |
| `status` | string | ✅ | `Completed`, `Cancelled`, `In Progress` |
| `reference` | string | ✅ | Booking reference |

---

## Asset & Holding Collections

### 13. **communityPosts**
User-generated community forum posts.

**Document ID**: Auto-generated

**Fields**:

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `userId` | string | ✅ | Post author user ID |
| `title` | string | ✅ | Post title |
| `body` | string | ✅ | Post content |
| `category` | string | ✅ | Post category |
| `likes` | number | ✅ | Like count (default 0) |
| `createdAt` | Timestamp | ✅ | Post creation time |

---

### 14. **events**
Events created and organized by users.

**Document ID**: Auto-generated

**Fields**:

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `userId` | string | ✅ | Event organizer user ID |
| `title` | string | ✅ | Event title |
| `description` | string | ✅ | Event details |
| `date` | Timestamp | ✅ | Event date |
| `location` | string | ✅ | Event location |
| `ticketPrice` | number | ✅ | Ticket price in kobo |
| `totalTickets` | number | ✅ | Total tickets available |
| `ticketsSold` | number | ✅ | Tickets sold so far |
| `status` | string | ✅ | `Active`, `Completed`, `Cancelled` |

---

### 15. **invoices**
Business invoices created by merchants.

**Document ID**: Auto-generated

**Fields**:

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `userId` | string | ✅ | Invoice creator user ID |
| `invoiceNumber` | string | ✅ | Unique invoice number |
| `clientName` | string | ✅ | Client/buyer name |
| `items` | array | ✅ | Invoice line items |
| `subtotal` | number | ✅ | Subtotal in kobo |
| `tax` | number | ✅ | Tax amount in kobo |
| `total` | number | ✅ | Total invoice amount in kobo |
| `dueDate` | Timestamp | ✅ | Payment due date |
| `status` | string | ✅ | `Draft`, `Sent`, `Paid`, `Overdue` |
| `createdAt` | Timestamp | ✅ | Invoice creation date |

---

## Inventory Collections

### 16. **products**
Inventory products managed by merchants.

**Document ID**: Auto-generated

**Fields**:

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `name` | string | ✅ | Product name |
| `sku` | string | ✅ | Stock keeping unit |
| `description` | string | ❌ | Product description |
| `price` | number | ✅ | Unit price in kobo |
| `quantity` | number | ✅ | Stock quantity |
| `category` | string | ✅ | Product category |
| `supplierId` | string | ❌ | Supplier reference |
| `createdAt` | Timestamp | ✅ | Creation timestamp |

---

### 17. **suppliers**
Supplier/vendor information.

**Document ID**: Auto-generated

**Fields**:

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `name` | string | ✅ | Supplier name |
| `contact` | string | ✅ | Contact phone/email |
| `address` | string | ✅ | Supplier address |
| `paymentTerms` | string | ❌ | e.g., "Net 30" |

---

### 18. **categories**
Product categories for inventory.

**Document ID**: Auto-generated

**Fields**:

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `name` | string | ✅ | Category name |
| `description` | string | ❌ | Category description |

---

### 19. **locations**
Inventory warehouse/store locations.

**Document ID**: Auto-generated

**Fields**:

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `name` | string | ✅ | Location name |
| `address` | string | ✅ | Physical address |
| `manager` | string | ❌ | Location manager name |

---

### 20. **inventoryTransactions**
Detailed stock movements and adjustments.

**Document ID**: Auto-generated

**Fields**:

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `productId` | string | ✅ | Product reference |
| `type` | string | ✅ | `purchase`, `sale`, `adjustment`, `transfer` |
| `quantity` | number | ✅ | Quantity moved |
| `price` | number | ✅ | Unit price in kobo |
| `date` | Timestamp | ✅ | Transaction date |
| `notes` | string | ❌ | Transaction notes |

---

## Support & Utility Collections

### 21. **supportTickets**
Customer support tickets.

**Document ID**: Auto-generated

**Fields**:

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `userId` | string | ✅ | Ticket creator user ID |
| `subject` | string | ✅ | Ticket subject |
| `message` | string | ✅ | Detailed issue description |
| `status` | string | ✅ | `Open`, `In Progress`, `Resolved`, `Closed` |
| `priority` | string | ✅ | `Low`, `Medium`, `High`, `Urgent` |
| `createdAt` | Timestamp | ✅ | Ticket creation time |
| `updatedAt` | Timestamp | ✅ | Last update time |

---

### 22. **payrollBatches**
Payroll batch processing for employers.

**Document ID**: Auto-generated

**Fields**:

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `userId` | string | ✅ | Employer user ID |
| `batchName` | string | ✅ | Payroll batch name |
| `totalAmount` | number | ✅ | Total payroll in kobo |
| `status` | string | ✅ | `Draft`, `Submitted`, `Processing`, `Completed` |
| `employees` | array | ✅ | Array of employee payroll entries |
| `createdAt` | Timestamp | ✅ | Batch creation date |

---

### 23. **posRequests**
Agent requests for POS terminals.

**Document ID**: Auto-generated

**Fields**:

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `userId` | string | ✅ | Agent user ID |
| `terminalCount` | number | ✅ | Number of POS terminals requested |
| `status` | string | ✅ | `Pending`, `Approved`, `Shipped`, `Delivered` |
| `reference` | string | ✅ | Request reference |
| `createdAt` | Timestamp | ✅ | Request date |

---

## Data Types & Enums

### UserAddress
```typescript
{
  line1: string;
  line2?: string;
  city: string;
  state: string;
  country: string;
}
```

### AgentDetails
```typescript
{
  businessName: string;
  businessAddress: string;
  posSerialNumber?: string;
  region: string;
  settlementAccount: {
    bankCode: string;
    accountNumber: string;
    accountName: string;
  };
}
```

### TransactionParty
```typescript
{
  name: string;
  account?: string;
  bank?: string;
}
```

### Repayment
```typescript
{
  dueDate: Timestamp;
  amount: number;  // in kobo
  status: string;  // "Due", "Paid", "Overdue"
}
```

### KycTier Enum
```
1 = Individual Basic (₦50,000 daily send, ₦200,000 daily receive)
2 = Individual Standard (₦500,000 daily send, ₦5,000,000 daily receive)
3 = Individual Advanced (₦5,000,000 daily send, unlimited daily receive)
4 = Corporate (unlimited send/receive)
```

### UserStatus Enum
```
"active"  = Account operational
"locked"  = Account restricted (failed logins, fraud)
"pending" = Account awaiting verification
```

---

## Limits & KYC Configuration

### Daily Transfer Limits (Debit)
| KYC Tier | Daily Limit |
|----------|------------|
| 1 | ₦50,000 |
| 2 | ₦500,000 |
| 3 | ₦5,000,000 |
| 4 | Unlimited |

### Daily Receive Limits (Credit)
| KYC Tier | Daily Limit |
|----------|------------|
| 1 | ₦200,000 |
| 2 | ₦5,000,000 |
| 3 | Unlimited |
| 4 | Unlimited |

### Implementation Location
- Debit/Credit Limits: `src/lib/user-data.ts` constants `DAILY_DEBIT_LIMITS_BY_KYC` & `DAILY_RECEIVE_LIMITS_BY_KYC`
- Enforcement: `performTransfer()` function in `src/lib/user-data.ts`

---

## Indexing Strategy

### Single-Field Indexes (Recommended)
```
users.phone
users.status
users.accountNumber
users.isAgent
notifications.userId
financialTransactions.reference
financialTransactions.userId
stockHoldings.userId
```

### Composite Indexes (Required for Queries)
```
financialTransactions:
  - (userId, type, timestamp)
  - (userId, category, timestamp)
  - (userId, reference)

loans:
  - (userId, status)

notifications:
  - (userId, createdAt)

events:
  - (userId, status)

invoices:
  - (userId, status)

investments:
  - (userId, status)
```

---

## Best Practices & Notes

1. **Kobo Storage**: All monetary values are stored in kobo (1 Naira = 100 kobo). Always divide by 100 when displaying in UI.

2. **Idempotency**: Use `reference` field in `financialTransactions` for idempotency checks before processing duplicate requests.

3. **Atomicity**: Financial operations use Firestore transactions to ensure consistency across multiple document updates.

4. **User Privacy**: Hash sensitive fields (`bvnHash`, `ninHash`, `loginPinHash`) using scrypt or bcrypt; never store plaintext.

5. **Audit Trail**: `financialTransactions` serves as the immutable ledger; never delete. Only update `balance` in `users` within a transaction alongside transaction logs.

6. **Real-time Updates**: Notifications use Firestore listeners (`onSnapshot`) for instant UI updates when transfers are received.

7. **Authentication**: All API routes validate `userId` from JWT tokens before allowing document access.

8. **Rate Limits**: Implement rate limiting per `userId` on high-frequency endpoints (e.g., transfers, loans).

9. **Backup & Recovery**: Regular backups of Firestore; use Cloud Firestore's built-in backup features.

10. **Security Rules**: Define proper Firestore security rules to prevent unauthorized access to other users' data.

---

## Migration Notes

If migrating from a different schema:

1. Map old field names to new ones.
2. Ensure `balance` is converted to kobo (multiply by 100 if originally in Naira).
3. Backfill transaction logs using historical data.
4. Update indices to reflect new composite queries.
5. Test all auth and transaction flows thoroughly.

---

## Schema Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | Dec 13, 2025 | Initial comprehensive schema documentation |

---

**Last Updated**: December 13, 2025  
**Maintained By**: Ovomonie Development Team
