name: Enterprise PR CI

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  security-events: write
  checks: write
  id-token: write

env:
  CI: "true"
  SRC_DIR: "."
  SBOM_FILE: "sbom.cdx.xml"

############################
# Top-level jobs overview:
# 1) prepare -> install, cache, unit tests, sbom
# 2) codeql-scan -> CodeQL analysis (parallel)
# 3) security-scans -> semgrep/trivy/checkov + SARIF
# 4) build-and-scan-image -> build container (optional), scan image
# 5) integration-e2e -> preview deploy + e2e + DAST
# 6) gate -> collate results and block PR if critical
############################

jobs:

  prepare:
    name: Prepare & Quick Checks (matrix)
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]   # Windows can be added if needed
        node-version: [18.x, 20.x]
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Cache pip (optional)
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}

      - name: Cache build (custom)
        uses: actions/cache@v4
        with:
          path: |
            ./.next/cache
            ./.cache
          key: build-${{ runner.os }}-${{ hashFiles('**/package-lock.json','**/yarn.lock') }}

      - name: Install dependencies
        run: |
          make ci-setup
        # If your repo needs python, ruby, go, add setup steps above.

      - name: Lint & static checks
        run: make lint
        continue-on-error: false

      - name: Types & compile checks
        run: make typecheck || true

      - name: Unit tests (fast)
        run: |
          make test:unit --silent
        continue-on-error: false

      - name: Generate SBOM (CycloneDX)
        run: syft . -o cyclonedx > $SBOM_FILE

      - name: Upload artifacts (unit test reports, sbom)
        uses: actions/upload-artifact@v4
        with:
          name: prepare-artifacts
          path: |
            coverage/
            test-results.xml
            $SBOM_FILE

  codeql-scan:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    needs: prepare
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript,python
          queries: security-extended  # enterprise teams often customize

      - name: Autobuild for CodeQL
        uses: github/codeql-action/autobuild@v3
        # optionally replace with your build step if autobuild doesn't work
        # with: { ... }

      - name: Run CodeQL analysis
        uses: github/codeql-action/analyze@v3
        with:
          upload: true

  security-scans:
    name: SAST / SCA / IaC
    runs-on: ubuntu-latest
    needs: [prepare]
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - name: Download prepare artifacts
        uses: actions/download-artifact@v4
        with:
          name: prepare-artifacts
          path: artifacts

      # Semgrep (SAST)
      - name: Semgrep (SAST)
        uses: returntocorp/semgrep-action@v1
        with:
          config: "p/ci"  # or "auto" / org rules
        continue-on-error: false

      # Trivy filesystem scan -> output SARIF for GitHub
      - name: Trivy - filesystem SCA -> sarif
        run: |
          trivy fs --format sarif -o trivy_fs.sarif .
        continue-on-error: false

      # Checkov for IaC -> sarif
      - name: Checkov IaC scan -> sarif
        run: |
          checkov -d . --output sarif --output-file-path checkov.sarif || true
        continue-on-error: true  # don't fail here; final gating evaluates severity

      # Upload SARIFs to GitHub Security (so they appear under Code scanning)
      - name: Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy_fs.sarif

      - name: Upload Checkov SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov.sarif

      - name: Save security reports as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            trivy_fs.sarif
            checkov.sarif
            semgrep-report.json

  build-and-scan-image:
    name: Build & Scan Container (optional)
    runs-on: ubuntu-latest
    needs: prepare
    if: ${{ env.BUILD_IMAGE == 'true' || github.event.pull_request.labels.*.name contains 'build-image' }}
    timeout-minutes: 20
    env:
      REGISTRY: ghcr.io  # TODO: change if using ECR/ACR
      IMAGE_NAME: ${{ github.repository }}:pr-${{ github.event.number }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build and push image (builder cache)
        uses: docker/build-push-action@v4
        with:
          context: .
          push: false
          tags: ${{ env.REGISTRY }}/${{ github.repository }}:pr-${{ github.event.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Scan built image with Trivy
        run: |
          trivy image --format sarif -o trivy_image.sarif ${{ env.REGISTRY }}/${{ github.repository }}:pr-${{ github.event.number }} || exit 0

      - name: Upload image SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy_image.sarif

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: container-scan
          path: trivy_image.sarif

  integration-e2e:
    name: Integration & E2E + DAST
    runs-on: ubuntu-latest
    needs: [security-scans, build-and-scan-image]
    timeout-minutes: 30
    environment:
      name: preview
      url: ${{ steps.post-preview.outputs.preview_url || '' }}
    steps:
      - uses: actions/checkout@v4
      - name: Create ephemeral preview environment
        id: create-preview
        run: |
          ./scripts/create-preview.sh > preview_url.txt
          echo "preview_url=$(cat preview_url.txt)" >> "$GITHUB_OUTPUT"
      - name: Wait for preview to become healthy
        run: ./scripts/wait-for-env.sh ${{ steps.create-preview.outputs.preview_url }}
        # wait-for-env should exit non-zero if environment never becomes healthy.

      - name: Run e2e tests (Playwright/Cypress)
        run: |
          PREVIEW_URL=${{ steps.create-preview.outputs.preview_url }} make test:e2e
        continue-on-error: false

      - name: Run DAST (OWASP ZAP baseline)
        run: |
          zap-baseline.py -t "${{ steps.create-preview.outputs.preview_url }}" -r zap-report.html || true

      - name: Upload e2e & dast artifacts
        uses: actions/upload-artifact@v4
        with:
          name: preview-reports
          path: |
            zap-report.html
            e2e-results.xml

      - name: Comment preview URL to PR
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ðŸ”Ž Preview deployed: ${{ steps.create-preview.outputs.preview_url }}
            - E2E results: uploaded as artifacts
            - DAST report: zap-report.html
            _This comment is updated by CI._

  gate:
    name: Gate & PR Decision
    runs-on: ubuntu-latest
    needs: [integration-e2e, security-scans, codeql-scan]
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Evaluate findings (script)
        env:
          TRIVY_SARIF: artifacts/trivy_fs.sarif
          CHECKOV_SARIF: artifacts/checkov.sarif
          ZAP_REPORT: artifacts/zap-report.html
        run: |
          # This script must parse SARIF/scan outputs and set exit code >0 for failing gates.
          # You can use jq + sarif processors or your own evaluator.
          ./scripts/gate-evaluator.sh --trivy trivy_fs.sarif --checkov checkov.sarif --zap zap-report.html
        continue-on-error: false

      - name: Post PR summary comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            âœ… Enterprise CI finished for PR #${{ github.event.number }}
            - Unit Tests: âœ…
            - Lint: âœ…
            - CodeQL: results uploaded to Security tab
            - Semgrep / Trivy / Checkov: results uploaded (SARIF)
            - Preview URL: ${{ steps.create-preview.outputs.preview_url || 'n/a' }}
            - Gate status: ${{ needs.gate.result }}
            Artifacts and detailed reports are attached to the run.

      - name: Set PR check conclusion (optional)
        if: failure()
        run: |
          echo "Gate failed â€” failing the job to block merge"
          exit 1
